<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Flight Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', monospace;
            overflow: hidden;
            background: #000;
        }
        #canvas-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0f0;
            font-size: 14px;
            text-shadow: 0 0 10px #0f0;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border: 2px solid #0f0;
            border-radius: 5px;
            min-width: 250px;
        }
        #hud .value {
            color: #fff;
            font-weight: bold;
            float: right;
        }
        #hud .row {
            margin: 5px 0;
            clear: both;
        }
        #hud .critical {
            color: #f00;
            animation: blink 0.5s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #0ff;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border: 1px solid #0ff;
            border-radius: 5px;
            max-width: 300px;
        }
        #camera-info {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #ff0;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border: 2px solid #ff0;
            border-radius: 5px;
        }
        #aircraft-selector {
            position: absolute;
            top: 120px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border: 1px solid #0ff;
            border-radius: 5px;
        }
        #aircraft-selector button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #222;
            color: #0ff;
            border: 1px solid #0ff;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        #aircraft-selector button:hover {
            background: #0ff;
            color: #000;
        }
        #aircraft-selector button.active {
            background: #0f0;
            color: #000;
            border-color: #0f0;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border: 3px solid #f00;
            border-radius: 10px;
            color: #f00;
            text-align: center;
            display: none;
            z-index: 100;
        }
        #game-over h2 {
            font-size: 32px;
            margin-bottom: 20px;
        }
        #game-over button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background: #f00;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        #game-over button:hover {
            background: #ff4444;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="hud">
        <div class="row"><span>ALTITUDE</span><span class="value" id="altitude">0 m</span></div>
        <div class="row"><span>SPEED</span><span class="value" id="speed">0 km/h</span></div>
        <div class="row"><span>FUEL</span><span class="value" id="fuel">100%</span></div>
        <div class="row"><span>THROTTLE</span><span class="value" id="throttle">0%</span></div>
        <div class="row"><span>DISTANCE</span><span class="value" id="distance">0 km</span></div>
        <div class="row"><span>TIME</span><span class="value" id="time">00:00</span></div>
    </div>

    <div id="camera-info">
        <div>CAMERA: <span id="camera-mode">Chase</span></div>
        <div style="margin-top: 5px; font-size: 11px;">Press C to change</div>
    </div>

    <div id="aircraft-selector">
        <div style="color: #0ff; margin-bottom: 10px;">AIRCRAFT:</div>
        <button onclick="changeAircraft('fighter')" class="active" id="btn-fighter">F-16 Fighter</button>
        <button onclick="changeAircraft('cargo')" id="btn-cargo">Cargo Plane</button>
        <button onclick="changeAircraft('glider')" id="btn-glider">Glider</button>
    </div>

    <div id="controls">
        <strong>CONTROLS:</strong><br>
        ↑/W - Pitch Down<br>
        ↓/S - Pitch Up<br>
        ←/A - Roll Left<br>
        →/D - Roll Right<br>
        Q/E - Yaw Left/Right<br>
        SHIFT - Increase Throttle<br>
        CTRL - Decrease Throttle<br>
        C - Change Camera<br>
        R - Reset Position
    </div>

    <div id="game-over">
        <h2>MISSION COMPLETE!</h2>
        <div id="final-stats"></div>
        <button onclick="restart()">RESTART</button>
        <button onclick="submitScore()">SUBMIT SCORE</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Game state
        let scene, camera, renderer, aircraft, terrain;
        let velocity = new THREE.Vector3(0, 0, 0);
        let rotation = new THREE.Euler(0, 0, 0);
        let angularVelocity = new THREE.Vector3(0, 0, 0);
        let throttle = 0;
        let fuel = 100;
        let distance = 0;
        let startTime = Date.now();
        let gameOver = false;
        let cameraMode = 0; // 0: chase, 1: cockpit, 2: orbit
        let cameraModes = ['Chase', 'Cockpit', 'Orbit'];

        // Aircraft types
        const aircraftTypes = {
            fighter: {
                maxSpeed: 500,
                acceleration: 0.5,
                fuelConsumption: 0.02,
                lift: 0.15,
                drag: 0.98,
                rollSpeed: 0.03,
                pitchSpeed: 0.02,
                color: 0x00ff00
            },
            cargo: {
                maxSpeed: 300,
                acceleration: 0.2,
                fuelConsumption: 0.03,
                lift: 0.12,
                drag: 0.96,
                rollSpeed: 0.015,
                pitchSpeed: 0.012,
                color: 0xffaa00
            },
            glider: {
                maxSpeed: 200,
                acceleration: 0.1,
                fuelConsumption: 0.005,
                lift: 0.2,
                drag: 0.99,
                rollSpeed: 0.025,
                pitchSpeed: 0.018,
                color: 0x00aaff
            }
        };
        let currentAircraft = 'fighter';

        // Keyboard state
        const keys = {};

        // Initialize scene
        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 1000, 10000);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
            camera.position.set(0, 100, 200);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x87CEEB);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(100, 200, 100);
            scene.add(sunLight);

            // Create terrain
            createTerrain();

            // Create aircraft
            createAircraft();

            // Create environment
            createEnvironment();

            // Event listeners
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
            window.addEventListener('keydown', handleKeyPress);

            animate();
        }

        function createAircraft() {
            if (aircraft) scene.remove(aircraft);

            aircraft = new THREE.Group();
            const config = aircraftTypes[currentAircraft];

            // Fuselage
            const bodyGeom = new THREE.CylinderGeometry(2, 2, 10, 8);
            const bodyMat = new THREE.MeshPhongMaterial({ color: config.color });
            const body = new THREE.Mesh(bodyGeom, bodyMat);
            body.rotation.z = Math.PI / 2;
            aircraft.add(body);

            // Wings
            const wingGeom = new THREE.BoxGeometry(20, 0.5, 5);
            const wingMat = new THREE.MeshPhongMaterial({ color: config.color });
            const wings = new THREE.Mesh(wingGeom, wingMat);
            wings.position.y = -1;
            aircraft.add(wings);

            // Tail
            const tailGeom = new THREE.BoxGeometry(6, 3, 0.5);
            const tail = new THREE.Mesh(tailGeom, wingMat);
            tail.position.set(-5, 1, 0);
            aircraft.add(tail);

            // Vertical stabilizer
            const vstabGeom = new THREE.BoxGeometry(0.5, 4, 3);
            const vstab = new THREE.Mesh(vstabGeom, wingMat);
            vstab.position.set(-5, 2, 0);
            aircraft.add(vstab);

            aircraft.position.set(0, 500, 0);
            scene.add(aircraft);
        }

        function createTerrain() {
            const terrainGroup = new THREE.Group();

            // Ground plane
            const groundGeom = new THREE.PlaneGeometry(20000, 20000, 100, 100);
            const vertices = groundGeom.attributes.position.array;
            
            // Add random height variation
            for (let i = 0; i < vertices.length; i += 3) {
                const x = vertices[i];
                const y = vertices[i + 1];
                vertices[i + 2] = Math.sin(x * 0.01) * 50 + Math.cos(y * 0.01) * 50;
            }
            groundGeom.computeVertexNormals();

            const groundMat = new THREE.MeshPhongMaterial({ 
                color: 0x228B22,
                flatShading: true
            });
            const ground = new THREE.Mesh(groundGeom, groundMat);
            ground.rotation.x = -Math.PI / 2;
            terrainGroup.add(ground);

            // Mountains
            for (let i = 0; i < 20; i++) {
                const mountainGeom = new THREE.ConeGeometry(
                    Math.random() * 200 + 100,
                    Math.random() * 400 + 200,
                    8
                );
                const mountainMat = new THREE.MeshPhongMaterial({ 
                    color: 0x8B7355,
                    flatShading: true
                });
                const mountain = new THREE.Mesh(mountainGeom, mountainMat);
                mountain.position.set(
                    (Math.random() - 0.5) * 8000,
                    0,
                    (Math.random() - 0.5) * 8000
                );
                terrainGroup.add(mountain);
            }

            scene.add(terrainGroup);
            terrain = terrainGroup;
        }

        function createEnvironment() {
            // Clouds
            for (let i = 0; i < 30; i++) {
                const cloudGeom = new THREE.SphereGeometry(50, 8, 8);
                const cloudMat = new THREE.MeshPhongMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.7
                });
                const cloud = new THREE.Mesh(cloudGeom, cloudMat);
                cloud.position.set(
                    (Math.random() - 0.5) * 5000,
                    Math.random() * 500 + 300,
                    (Math.random() - 0.5) * 5000
                );
                cloud.scale.set(2, 1, 1.5);
                scene.add(cloud);
            }
        }

        function updatePhysics() {
            if (gameOver) return;

            const config = aircraftTypes[currentAircraft];
            const dt = 1/60;

            // Fuel consumption
            if (fuel > 0) {
                fuel -= throttle * config.fuelConsumption * dt;
                fuel = Math.max(0, fuel);
            }

            // Throttle control
            if (keys['shift'] && fuel > 0) {
                throttle = Math.min(100, throttle + 1);
            }
            if (keys['control']) {
                throttle = Math.max(0, throttle - 1);
            }

            // Control inputs
            if (keys['w'] || keys['arrowup']) angularVelocity.x += config.pitchSpeed;
            if (keys['s'] || keys['arrowdown']) angularVelocity.x -= config.pitchSpeed;
            if (keys['a'] || keys['arrowleft']) angularVelocity.z += config.rollSpeed;
            if (keys['d'] || keys['arrowright']) angularVelocity.z -= config.rollSpeed;
            if (keys['q']) angularVelocity.y += 0.01;
            if (keys['e']) angularVelocity.y -= 0.01;

            // Apply damping to angular velocity
            angularVelocity.multiplyScalar(0.95);

            // Update rotation
            aircraft.rotation.x += angularVelocity.x;
            aircraft.rotation.y += angularVelocity.y;
            aircraft.rotation.z += angularVelocity.z;

            // Physics
            const forward = new THREE.Vector3(1, 0, 0);
            forward.applyEuler(aircraft.rotation);

            // Thrust
            const thrust = (throttle / 100) * config.acceleration * (fuel > 0 ? 1 : 0);
            velocity.add(forward.multiplyScalar(thrust));

            // Lift (based on speed and pitch)
            const speed = velocity.length();
            const liftForce = speed * config.lift * Math.sin(aircraft.rotation.x);
            velocity.y += liftForce;

            // Gravity
            velocity.y -= 0.2;

            // Drag
            velocity.multiplyScalar(config.drag);

            // Limit speed
            const currentSpeed = velocity.length();
            if (currentSpeed > config.maxSpeed) {
                velocity.normalize().multiplyScalar(config.maxSpeed);
            }

            // Update position
            aircraft.position.add(velocity);

            // Track distance
            distance += velocity.length() * 0.001;

            // Ground collision
            if (aircraft.position.y < 10) {
                if (velocity.length() > 5) {
                    endGame('CRASHED!');
                } else {
                    aircraft.position.y = 10;
                    velocity.y = 0;
                }
            }

            // Out of fuel
            if (fuel <= 0 && throttle > 0) {
                throttle = 0;
            }
        }

        function updateCamera() {
            if (!aircraft) return;

            const offset = new THREE.Vector3();
            
            switch(cameraMode) {
                case 0: // Chase
                    offset.set(-30, 10, 0);
                    offset.applyEuler(aircraft.rotation);
                    camera.position.copy(aircraft.position).add(offset);
                    camera.lookAt(aircraft.position);
                    break;
                    
                case 1: // Cockpit
                    offset.set(4, 2, 0);
                    offset.applyEuler(aircraft.rotation);
                    camera.position.copy(aircraft.position).add(offset);
                    const lookTarget = aircraft.position.clone();
                    const forward = new THREE.Vector3(10, 0, 0);
                    forward.applyEuler(aircraft.rotation);
                    lookTarget.add(forward);
                    camera.lookAt(lookTarget);
                    break;
                    
                case 2: // Orbit
                    const orbitRadius = 50;
                    const angle = Date.now() * 0.0005;
                    camera.position.x = aircraft.position.x + Math.cos(angle) * orbitRadius;
                    camera.position.z = aircraft.position.z + Math.sin(angle) * orbitRadius;
                    camera.position.y = aircraft.position.y + 20;
                    camera.lookAt(aircraft.position);
                    break;
            }
        }

        function updateHUD() {
            document.getElementById('altitude').textContent = Math.floor(aircraft.position.y) + ' m';
            document.getElementById('speed').textContent = Math.floor(velocity.length() * 10) + ' km/h';
            
            const fuelDisplay = document.getElementById('fuel');
            fuelDisplay.textContent = Math.floor(fuel) + '%';
            fuelDisplay.className = fuel < 20 ? 'value critical' : 'value';
            
            document.getElementById('throttle').textContent = Math.floor(throttle) + '%';
            document.getElementById('distance').textContent = distance.toFixed(1) + ' km';
            
            const elapsed = (Date.now() - startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            document.getElementById('time').textContent = 
                String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }

        function handleKeyPress(e) {
            if (e.key.toLowerCase() === 'c') {
                cameraMode = (cameraMode + 1) % 3;
                document.getElementById('camera-mode').textContent = cameraModes[cameraMode];
            }
            if (e.key.toLowerCase() === 'r') {
                resetPosition();
            }
        }

        function resetPosition() {
            aircraft.position.set(0, 500, 0);
            aircraft.rotation.set(0, 0, 0);
            velocity.set(0, 0, 0);
            angularVelocity.set(0, 0, 0);
        }

        function changeAircraft(type) {
            currentAircraft = type;
            createAircraft();
            resetPosition();
            
            // Update button states
            document.querySelectorAll('#aircraft-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('btn-' + type).classList.add('active');
        }

        function endGame(reason) {
            gameOver = true;
            const elapsed = (Date.now() - startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            
            document.getElementById('final-stats').innerHTML = `
                <p style="color: #fff; margin: 10px 0;">${reason}</p>
                <p style="color: #0ff;">Distance: ${distance.toFixed(1)} km</p>
                <p style="color: #0ff;">Time: ${minutes}:${String(seconds).padStart(2, '0')}</p>
                <p style="color: #0ff;">Score: ${Math.floor(distance * 100)}</p>
            `;
            document.getElementById('game-over').style.display = 'block';
        }

        function restart() {
            gameOver = false;
            fuel = 100;
            throttle = 0;
            distance = 0;
            startTime = Date.now();
            resetPosition();
            document.getElementById('game-over').style.display = 'none';
        }

        function submitScore() {
            const score = Math.floor(distance * 100);
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('gameId');
            
            const elapsed = (Date.now() - startTime) / 1000;
            
            window.parent.postMessage({
                type: 'SUBMIT_SCORE',
                gameId: gameId,
                score: score,
                metadata: {
                    distance: distance.toFixed(1),
                    time: elapsed,
                    aircraft: currentAircraft
                }
            }, '*');
            
            document.getElementById('game-over').style.display = 'none';
            restart();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            updatePhysics();
            updateCamera();
            updateHUD();
            
            renderer.render(scene, camera);

            // Auto end game after 5 minutes or 50km
            if (distance > 50 || (Date.now() - startTime) > 300000) {
                if (!gameOver) endGame('MISSION COMPLETE!');
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Start the game
        init();
    </script>
</body>
</html>
